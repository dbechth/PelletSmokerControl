<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pellet Smoker Control</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: #e0e0e0; padding: 10px; }
        .container { max-width: 900px; margin: 0 auto; }
        header { text-align: center; padding: 20px; background: #2a2a2a; border-radius: 8px; margin-bottom: 20px; }
        h1 { color: #ff6b35; margin-bottom: 10px; }
        .nav { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav button { flex: 1; min-width: 120px; padding: 12px; background: #ff6b35; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; transition: background 0.3s; }
        .nav button:hover { background: #ff5722; }
        .nav button.active { background: #004e89; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: #2a2a2a; border-radius: 8px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #ff6b35; }
        .card h2 { color: #ff6b35; margin-bottom: 15px; font-size: 18px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat { background: #1a1a1a; padding: 15px; border-radius: 6px; text-align: center; }
        .stat label { display: block; font-size: 12px; color: #888; margin-bottom: 5px; }
        .stat .value { font-size: 28px; color: #ff6b35; font-weight: bold; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #ff6b35; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: #1a1a1a; color: #e0e0e0; border: 1px solid #444; border-radius: 4px; font-size: 14px; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #ff6b35; box-shadow: 0 0 5px rgba(255, 107, 53, 0.3); }
        .btn-save { width: 100%; padding: 12px; background: #ff6b35; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .btn-save:hover { background: #ff5722; }
        .recipe-item { background: #1a1a1a; padding: 15px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid #444; }
        .recipe-item.selected { border-left-color: #ff6b35; background: #252525; }
        .file-input { display: flex; gap: 10px; align-items: center; }
        .file-input input[type="file"] { flex: 1; }
        .btn-download { width: 100%; padding: 12px; background: #004e89; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .btn-download:hover { background: #003d6b; }
        .control-btn { width: 100%; padding: 15px; background: #333; color: white; border: 2px solid #555; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 16px; transition: all 0.3s; }
        .control-btn:hover { background: #444; border-color: #777; }
        .control-btn.active { background: #ff6b35; border-color: #ff6b35; color: white; }
        .message { padding: 12px; border-radius: 6px; margin-bottom: 15px; display: none; }
        .message.success { background: #1e4620; color: #4caf50; display: block; }
        .message.error { background: #4a1f1f; color: #f44336; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pellet Smoker Control</h1>
        </header>

        <div class="nav">
            <button class="nav-btn active" data-page="main">Main</button>
            <button class="nav-btn" data-page="tunable">Parameters</button>
            <button class="nav-btn" data-page="recipe">Recipes</button>
            <button class="nav-btn" data-page="config">Config</button>
        </div>

        <div id="main" class="page active">
            <div class="card">
                <h2>State: <span id="activeState"></span></h2>
                <div class="grid">
                    <div class="stat">
                        <label>Smoke Chamber</label>
                        <div class="value" id="smokeChamberTemp">--F</div>
                    </div>
                    <div class="stat">
                        <label>Fire Pot</label>
                        <div class="value" id="firePotTemp">--F</div>
                    </div>
                    <div class="stat">
                        <label>Setpoint</label>
                        <div class="value" id="setpoint">--F</div>
                    </div>
                    <div class="stat">
                        <label>Smoke Setpoint</label>
                        <div class="value" id="smokeSetpoint">--</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Control Buttons</h2>
                <div class="grid">
                    <div class="stat">
                        <label>Startup</label>
                        <button class="control-btn" id="btn_Startup" onclick="toggleButton('btn_Startup')">OFF</button>
                    </div>
                    <div class="stat">
                        <label>Auto</label>
                        <button class="control-btn" id="btn_Auto" onclick="toggleButton('btn_Auto')">OFF</button>
                    </div>
                    <div class="stat">
                        <label>Shutdown</label>
                        <button class="control-btn" id="btn_Shutdown" onclick="toggleButton('btn_Shutdown')">OFF</button>
                    </div>
                    <div class="stat">
                        <label>Manual</label>
                        <button class="control-btn" id="btn_Manual" onclick="toggleButton('btn_Manual')">OFF</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Actuator Status</h2>
                <div class="grid">
                    <div class="stat">
                        <label>Igniter</label>
                        <div class="value" id="igniterStatus">OFF</div>
                    </div>
                    <div class="stat">
                        <label>Auger</label>
                        <div class="value" id="augerStatus">OFF</div>
                    </div>
                    <div class="stat">
                        <label>Fan</label>
                        <div class="value" id="fanStatus">OFF</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tunable" class="page">
            <div class="card">
                <h2>Operating Parameters</h2>
                <div class="form-group">
                    <label>Target Temperature (F)</label>
                    <input type="number" id="setpointInput" step="5" min="175" max="500">
                    <button class="btn-save" onclick="saveSetpoint()">Save Setpoint</button>
                </div>
                <div class="form-group">
                    <label>Smoke Level</label>
                    <input type="number" id="smokeSetpointInput" step="5" min="0" max="100">
                    <button class="btn-save" onclick="saveSmokeSetpoint()">Save Smoke Level</button>
                </div>
            </div>

            <div class="card">
                <h2>Tunable Parameters</h2>
                <div id="tunableMessage" class="message"></div>
                <div class="form-group">
                    <label>Min Auto Restart Temp (F)</label>
                    <input type="number" id="minAutoRestartTemp" step="1" min="0" max="500">
                </div>
                <div class="form-group">
                    <label>Min Idle Temp (F)</label>
                    <input type="number" id="minIdleTemp" step="1" min="0" max="500">
                </div>
                <div class="form-group">
                    <label>Fire Pot Burning Temp (F)</label>
                    <input type="number" id="firePotBurningTemp" step="1" min="-500" max="500">
                </div>
                <div class="form-group">
                    <label>Startup Fill Time (ms)</label>
                    <input type="number" id="startupFillTime" step="1000" min="0">
                </div>
                <div class="form-group">
                    <label>Igniter Preheat Time (ms)</label>
                    <input type="number" id="igniterPreheatTime" step="1000" min="0">
                </div>
                <div class="form-group">
                    <label>Stabilize Time (ms)</label>
                    <input type="number" id="stabilizeTime" step="1000" min="0">
                </div>
                <button class="btn-save" onclick="saveTunableParams()">Save All Parameters</button>
            </div>
        </div>

        <div id="recipe" class="page">
            <div class="card">
                <h2>Recipe Management</h2>
                <div id="recipeMessage" class="message"></div>
                <div id="recipeList"></div>
                <button class="btn-save" onclick="saveRecipeState()">Save Recipes</button>
            </div>
        </div>

        <div id="config" class="page">
            <div class="card">
                <h2>Configuration Management</h2>
                <button class="btn-download" onclick="downloadConfig()">Download Config</button>
                <div class="file-input">
                    <input type="file" id="configFile" accept=".json">
                    <button class="btn-save" onclick="uploadConfig()">Upload Config</button>
                </div>
                <div id="configMessage" class="message"></div>
            </div>
            <div class="card">
                <h2>SPIFFS File Manager</h2>
                <div class="form-group">
                    <label>Upload File</label>
                    <input type="file" id="spiffsFileInput">
                    <input type="text" id="spiffsPath" placeholder="/path/on/spiffs.txt" style="margin-top:8px; width:100%;">
                    <button class="btn-save" onclick="uploadSPIFSFile()">Upload to SPIFFS</button>
                </div>
                <div class="form-group">
                    <label>Files on SPIFFS</label>
                    <div id="spiffsFileList"></div>
                    <button class="btn-save" onclick="listFiles()" style="margin-top:8px;">Refresh List</button>
                </div>
                <div id="spiffsMessage" class="message"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let statusRefreshInterval;

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const pageId = this.getAttribute('data-page');
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                this.classList.add('active');
                if (pageId === 'tunable') loadTunableParams();
                if (pageId === 'recipe') loadRecipeState();
                if (pageId === 'main') loadOperatingParams();
                if (pageId === 'config') listFiles();
            });
        });

        async function refreshStatus() {
            try {
                const response = await fetch(API_BASE + '/status');
                const data = await response.json();
                document.getElementById('smokeChamberTemp').textContent = data.smokeChamberTemp.toFixed(1) + 'F';
                document.getElementById('firePotTemp').textContent = data.firePotTemp.toFixed(1) + 'F';
                document.getElementById('setpoint').textContent = data.operating.setpoint.toFixed(1) + 'F';
                document.getElementById('smokeSetpoint').textContent = data.operating.smokesetpoint.toFixed(1);
                document.getElementById('activeState').textContent = data.operating.activeState;
                document.getElementById('igniterStatus').textContent = data.igniterMode === 0 ? 'OFF' : 'ON';
                const augerModes = ['OFF','ON','Auto','Manual','Mass'];
                document.getElementById('augerStatus').textContent = augerModes[data.augerMode] || 'OFF';
                document.getElementById('fanStatus').textContent = data.fanMode === 0 ? 'OFF' : 'ON';
                // Do NOT update input fields here. Inputs represent user edits
                // and should only be populated on initial load or explicit param loads.
                refreshButtons();
            } catch (error) { console.error('Error:', error); }
        }

        async function refreshButtons() {
            try {
                const response = await fetch(API_BASE + '/buttons');
                const data = await response.json();
                
                const buttons = ['btn_Startup', 'btn_Auto', 'btn_Shutdown', 'btn_Manual'];
                buttons.forEach(btn => {
                    const button = document.getElementById(btn);
                    const isActive = data[btn];
                    button.textContent = isActive ? 'ON' : 'OFF';
                    if (isActive) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                });
            } catch (error) { console.error('Error:', error); }
        }

        async function toggleButton(buttonName) {
            try {
                const button = document.getElementById(buttonName);
                const currentState = button.classList.contains('active');
                const newState = !currentState;
                
                await fetch(API_BASE + '/buttons', { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify({button: buttonName, state: newState}) 
                });
                
                // Update button appearance immediately
                button.textContent = newState ? 'ON' : 'OFF';
                if (newState) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            } catch (error) { console.error('Error:', error); }
        }

        async function setMode(mode) {
            try {
                await fetch(API_BASE + '/operating/mode', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({mode: mode}) });
                refreshStatus();
            } catch (error) { console.error('Error:', error); }
        }

        async function saveSetpoint() {
            try {
                const setpoint = parseFloat(document.getElementById('setpointInput').value);
                console.log('Saving setpoint:', setpoint);
                if (isNaN(setpoint)) {
                    alert('Invalid setpoint value');
                    return;
                }
                const response = await fetch(API_BASE + '/operating/setpoint', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({setpoint: setpoint}) });
                console.log('Response:', response.status);
                refreshStatus();
            } catch (error) { console.error('Error:', error); }
        }

        async function saveSmokeSetpoint() {
            try {
                const smokesetpoint = parseFloat(document.getElementById('smokeSetpointInput').value);
                console.log('Saving smokesetpoint:', smokesetpoint);
                if (isNaN(smokesetpoint)) {
                    alert('Invalid smoke level value');
                    return;
                }
                const response = await fetch(API_BASE + '/operating/smokesetpoint', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({smokesetpoint: smokesetpoint}) });
                console.log('Response:', response.status);
                refreshStatus();
            } catch (error) { console.error('Error:', error); }
        }

        async function loadOperatingParams() {
            try {
                const response = await fetch(API_BASE + '/status');
                const data = await response.json();
                // Populate input fields from persisted config/status. Call this
                // only on initial page load or when user navigates to the main page.
                document.getElementById('setpointInput').value = data.operating.setpoint;
                document.getElementById('smokeSetpointInput').value = data.operating.smokesetpoint;
                refreshButtons();
            } catch (error) { console.error('Error loading operating params:', error); }
        }

        async function loadTunableParams() {
            try {
                const response = await fetch(API_BASE + '/tunable');
                const data = await response.json();
                document.getElementById('minAutoRestartTemp').value = data.minAutoRestartTemp;
                document.getElementById('minIdleTemp').value = data.minIdleTemp;
                document.getElementById('firePotBurningTemp').value = data.firePotBurningTemp;
                document.getElementById('startupFillTime').value = data.startupFillTime;
                document.getElementById('igniterPreheatTime').value = data.igniterPreheatTime;
                document.getElementById('stabilizeTime').value = data.stabilizeTime;
            } catch (error) { console.error('Error:', error); }
        }

        async function saveTunableParams() {
            try {
                const data = {
                    minAutoRestartTemp: parseFloat(document.getElementById('minAutoRestartTemp').value),
                    minIdleTemp: parseFloat(document.getElementById('minIdleTemp').value),
                    firePotBurningTemp: parseFloat(document.getElementById('firePotBurningTemp').value),
                    startupFillTime: parseInt(document.getElementById('startupFillTime').value),
                    igniterPreheatTime: parseInt(document.getElementById('igniterPreheatTime').value),
                    stabilizeTime: parseInt(document.getElementById('stabilizeTime').value)
                };
                const response = await fetch(API_BASE + '/tunable', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                const msg = document.getElementById('tunableMessage');
                if (response.ok) { msg.className = 'message success'; msg.textContent = 'Parameters saved'; } else { msg.className = 'message error'; msg.textContent = 'Error saving'; }
                setTimeout(() => msg.className = 'message', 3000);
            } catch (error) { console.error('Error:', error); }
        }

        async function loadRecipeState() {
            try {
                const response = await fetch(API_BASE + '/recipe');
                const data = await response.json();
                const list = document.getElementById('recipeList');
                list.innerHTML = '';
                data.recipes.forEach((recipe, idx) => {
                    const div = document.createElement('div');
                    div.className = 'recipe-item' + (idx === data.selectedRecipeIndex ? ' selected' : '');
                    div.innerHTML = '<strong>' + (recipe.name || 'Recipe ' + (idx + 1)) + '</strong> ' + (recipe.enabled ? 'OK' : '') + '<br><small>' + recipe.stepCount + ' steps</small>';
                    div.style.cursor = 'pointer';
                    div.onclick = () => selectRecipe(idx);
                    list.appendChild(div);
                });
            } catch (error) { console.error('Error:', error); }
        }

        async function selectRecipe(idx) {
            try {
                const response = await fetch(API_BASE + '/recipe', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({selectedRecipeIndex: idx}) });
                if (response.ok) loadRecipeState();
            } catch (error) { console.error('Error:', error); }
        }

        async function saveRecipeState() {
            const msg = document.getElementById('recipeMessage');
            msg.className = 'message success';
            msg.textContent = 'Recipe state saved';
            setTimeout(() => msg.className = 'message', 3000);
        }

        async function downloadConfig() {
            try {
                const response = await fetch(API_BASE + '/config/download');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'smokerConfig.json';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) { console.error('Error:', error); }
        }

        async function uploadConfig() {
            try {
                const file = document.getElementById('configFile').files[0];
                if (!file) return;
                const text = await file.text();
                const response = await fetch(API_BASE + '/config/upload', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: text });
                const msg = document.getElementById('configMessage');
                if (response.ok) { msg.className = 'message success'; msg.textContent = 'Config uploaded'; document.getElementById('configFile').value = ''; setTimeout(() => location.reload(), 1500); } else { msg.className = 'message error'; msg.textContent = 'Error uploading'; }
            } catch (error) { console.error('Error:', error); }
        }

        // SPIFFS file manager functions
        async function listFiles() {
            try {
                const response = await fetch(API_BASE + '/spiffs/list');
                const data = await response.json();
                const list = document.getElementById('spiffsFileList');
                list.innerHTML = '';
                (data.files || []).forEach(f => {
                    const row = document.createElement('div');
                    row.className = 'recipe-item';
                    row.innerHTML = `<strong>${f.name}</strong> <small>${f.size} bytes</small>`;
                    const dl = document.createElement('button'); dl.textContent = 'Download'; dl.style.marginLeft = '8px'; dl.onclick = () => downloadSPIFS(f.name);
                    const del = document.createElement('button'); del.textContent = 'Delete'; del.style.marginLeft = '8px'; del.onclick = () => deleteSPIFS(f.name);
                    row.appendChild(dl);
                    row.appendChild(del);
                    list.appendChild(row);
                });
            } catch (error) { console.error('Error listing spiffs:', error); }
        }

        async function downloadSPIFS(path) {
            try {
                const url = API_BASE + '/spiffs/download?path=' + encodeURIComponent(path);
                const response = await fetch(url);
                if (!response.ok) { alert('Download failed'); return; }
                const blob = await response.blob();
                const a = document.createElement('a');
                const urlObj = window.URL.createObjectURL(blob);
                a.href = urlObj;
                a.download = path.replace(/^.*\//, '');
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(urlObj);
            } catch (error) { console.error('Error downloading spiffs file:', error); }
        }

        async function deleteSPIFS(path) {
            if (!confirm('Delete ' + path + '?')) return;
            try {
                const response = await fetch(API_BASE + '/spiffs/delete?path=' + encodeURIComponent(path), { method: 'POST' });
                if (response.ok) listFiles(); else alert('Delete failed');
            } catch (error) { console.error('Error deleting spiffs file:', error); }
        }

        async function uploadSPIFSFile() {
            try {
                const fileInput = document.getElementById('spiffsFileInput');
                const pathInput = document.getElementById('spiffsPath');
                if (!fileInput.files.length) { alert('Select a file'); return; }
                const file = fileInput.files[0];
                let path = pathInput.value.trim();
                if (!path) path = '/' + file.name;
                if (!path.startsWith('/')) path = '/' + path;

                const data = await file.arrayBuffer();
                const response = await fetch(API_BASE + '/spiffs/upload?path=' + encodeURIComponent(path), { method: 'POST', headers: {'Content-Type':'application/octet-stream'}, body: data });
                const msg = document.getElementById('spiffsMessage');
                if (response.ok) { msg.className = 'message success'; msg.textContent = 'Uploaded'; fileInput.value = ''; pathInput.value = ''; listFiles(); } else { msg.className = 'message error'; msg.textContent = 'Upload failed'; }
                setTimeout(() => msg.className = 'message', 3000);
            } catch (error) { console.error('Error uploading spiffs file:', error); }
        }

        refreshStatus();
        // Populate inputs from persisted operating params once on initial load
        loadOperatingParams();
        statusRefreshInterval = setInterval(refreshStatus, 1000);
    </script>
</body>
</html>
